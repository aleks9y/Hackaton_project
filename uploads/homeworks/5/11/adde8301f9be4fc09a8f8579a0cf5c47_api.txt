from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from database.engine import get_session
from database.models import ThemeProgress, Theme, User
from utils.auth import get_current_user
from datetime import datetime

progress_router = APIRouter()

@progress_router.post("/themes/{theme_id}/mark-completed")
async def mark_theme_completed(
    theme_id: int,
    session: AsyncSession = Depends(get_session),
    current_user: User = Depends(get_current_user),
):
    """Отметить тему как пройденную"""
    # Проверяем существование темы
    result = await session.execute(select(Theme).filter(Theme.id == theme_id))
    theme = result.scalar_one_or_none()
    
    if not theme:
        raise HTTPException(status_code=404, detail="Theme not found")
    
    # Проверяем, не отмечена ли тема уже как пройденная
    result = await session.execute(
        select(ThemeProgress).filter(
            ThemeProgress.user_id == current_user.id,
            ThemeProgress.theme_id == theme_id
        )
    )
    existing_progress = result.scalar_one_or_none()
    
    if existing_progress:
        # Если уже отмечена, обновляем
        existing_progress.is_completed = True
        existing_progress.completed_at = datetime.now()
    else:
        # Если нет, создаем новую запись
        progress = ThemeProgress(
            user_id=current_user.id,
            theme_id=theme_id,
            is_completed=True,
            completed_at=datetime.now()
        )
        session.add(progress)
    
    await session.commit()
    return {"message": "Theme marked as completed"}

@progress_router.get("/courses/{course_id}/progress")
async def get_course_progress(
    course_id: int,
    session: AsyncSession = Depends(get_session),
    current_user: User = Depends(get_current_user),
):
    """Получить прогресс по курсу"""
    # Получаем все темы курса
    result = await session.execute(
        select(Theme).filter(Theme.course_id == course_id)
    )
    themes = result.scalars().all()
    
    # Получаем прогресс пользователя по этим темам
    result = await session.execute(
        select(ThemeProgress).filter(
            ThemeProgress.user_id == current_user.id,
            ThemeProgress.theme_id.in_([theme.id for theme in themes])
        )
    )
    user_progress = result.scalars().all()
    
    # Создаем словарь для быстрого доступа
    progress_dict = {progress.theme_id: progress for progress in user_progress}
    
    # Формируем ответ
    completed_count = sum(1 for progress in user_progress if progress.is_completed)
    total_count = len(themes)
    progress_percentage = (completed_count / total_count * 100) if total_count > 0 else 0
    
    return {
        "completed_count": completed_count,
        "total_count": total_count,
        "progress_percentage": progress_percentage,
        "themes_progress": [
            {
                "theme_id": theme.id,
                "theme_name": theme.name,
                "is_completed": progress_dict.get(theme.id) and progress_dict[theme.id].is_completed,
                "is_homework": theme.is_homework
            }
            for theme in themes
        ]
    }